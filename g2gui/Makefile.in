GCJ=@GCJ@
FIND=@FIND@

JAR_DIR=@JAR_DIR@
SRC_DIR=@SRC_DIR@
OBJ_DIR=@OBJ_DIR@
RES_DIR=@RES_DIR@
SWT_DIR=@SWT_DIR@

GCJ_ARGS=-c -w -O2
SWT_ARGS=-fjni

INSTALLPREFIX=@prefix@/g2gui

PROPERTIES=$(SRC_DIR)/g2gui.properties

G2GUI_CLASSPATH:=@CLASSPATH@

MAINCLASS=net.mldonkey.g2gui.view.G2Gui

UNAME=$(word 1, $(shell uname -a))

ifeq ($(UNAME),Linux)
	SYSTYPE=gtk
	PROGRAM=g2gui
	LINK_ARGS= -s -static-libgcc -Wl,-rpath,.
	G2GUI_CLASSPATH:=$(subst .jar ,.jar:,$(G2GUI_CLASSPATH))
else
	SYSTYPE=win
	PROGRAM=g2gui.exe
	LINK_ARGS=-s -mwindows \
	-Dgnu.gcj.runtime.NameFinder.demangle=false \
	-Dgnu.gcj.runtime.NameFinder.use_addr2line=false
	LIBGCJ=$(SWT_DIR)/libswt.a
	G2GUI_CLASSPATH:=$(subst .jar ,.jar\;,$(G2GUI_CLASSPATH))
endif

JAROBJECTS = $(subst .jar,.o, $(notdir $(wildcard $(JAR_DIR)/*.jar)))
SWTOBJECTS = $(subst .jar,.o, $(notdir $(wildcard $(SWT_DIR)/*.jar)))

#G2GUI_RESOBJECTS =@G2GUI_RESOBJECTS@ 
#SWT_RESOBJECTS =@SWT_RESOBJECTS@ 


G2GUI_RESOBJECTS=$(subst /,.,$(shell $(FIND) $(SRC_DIR) -type f  ! -name "*.java" -printf "%p.o "))
OTHER_RESOBJECTS=$(subst /,.,$(shell $(FIND) $(RES_DIR) -type f  ! -name "*.java" -printf "%p.o "))

SRCOBJECTS = $(subst /,.,$(shell $(FIND) $(SRC_DIR) -type f  -name "*.java" -printf "%p.o "))

#vpath %.jar $(JAR_DIR) $(SWT_DIR)
#vpath %.java $(shell $(FIND) $(SRC_DIR) -type d)
#vpath %.o $(OBJ_DIR)
#vpath % $(shell $(FIND) -type d)

vpath % $(shell $(FIND) $(JAR_DIR) $(SWT_DIR) $(SRC_DIR) $(OBJ_DIR) $(RES_DIR) -type d)

define file_path
$(subst .,/,$(basename $*))$(suffix $*)
endef

#.SUFFIXES:

all : mkobjdir $(G2GUI_RESOBJECTS) $(OTHER_RESOBJECTS) $(SWTOBJECTS) $(JAROBJECTS) $(SRCOBJECTS) link
	@echo --- DONE ---


$(SWTOBJECTS) : %.o : %.jar
	 $(GCJ) --CLASSPATH=$(G2GUI_CLASSPATH) $(SWT_ARGS) $(GCJ_ARGS) -o $(OBJ_DIR)/$@ $<			
	
$(JAROBJECTS) : %.o : %.jar
	$(GCJ) --CLASSPATH=$(G2GUI_CLASSPATH) $(GCJ_ARGS) -o $(OBJ_DIR)/$@ $<


$(G2GUI_RESOBJECTS) : %.o : $(subst .,/,$<)
	$(GCJ) $(GCJ_ARGS) --resource $(subst $(SRC_DIR)/,,$(file_path)) -o $(OBJ_DIR)/$@ $(file_path)

$(OTHER_RESOBJECTS) :%.o : $(subst .,/,$<)
	$(GCJ) $(GCJ_ARGS) --resource $(subst $(RES_DIR)/,,$(file_path)) -o $(OBJ_DIR)/$@ $(file_path)
		
$(SRCOBJECTS) : %.o : $(subst .,/,$<)
	$(GCJ) --CLASSPATH=$(G2GUI_CLASSPATH) $(GCJ_ARGS) -o $(OBJ_DIR)/$@ $(file_path)
		

link :
	$(GCJ) --main=$(MAINCLASS) $(LINK_ARGS) -o $(PROGRAM) $(OBJ_DIR)/*.o $(LIBSWT)
	cp $(SWT_DIR)/libswt* .

mkobjdir :
	@if [ ! -d $(OBJ_DIR) ]; then  \
	mkdir $(OBJ_DIR) ;\
	fi

